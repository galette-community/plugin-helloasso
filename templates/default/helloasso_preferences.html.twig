{#
/**
 * Copyright Â© 2003-2025 The Galette Team
 *
 * This file is part of Galette Helloasso plugin (https://galette-community.github.io/plugin-helloasso).
 *
 * Galette is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Galette is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Galette. If not, see <http://www.gnu.org/licenses/>.
 */
#}
{% extends 'page.html.twig' %}

{% block content %}
    <form id="helloasso_settings" action="{{ url_for("store_helloasso_preferences") }}" method="post" enctype="multipart/form-data" class="ui form">
        {% if not helloasso.isLoaded() %}
            <div id="errorbox" class="ui error icon visible message">
                <i class="exclamation circle icon" aria-hidden="true"></i>
                <div class="content">
                    <div class="header">
                        {{ _T("Cannot load the settings", "helloasso") }}
                    </div>
                    <p>
                        {{ _T("An error occured while loading the settings from the database.", "helloasso") }}<br/>
                        {{ _T("Please, check if the plugin's database has been properly initialized.", "helloasso") }}
                    </p>
                </div>
            </div>
        {% else %}
            <div class="ui stackable pointing inverted menu tabbed">
                <a href="{{ url_for('helloasso_preferences') }}?tab=helloasso" class="item{{ tab == 'helloasso' ? ' active' }}" data-tab="helloasso">{{ _T("Parameters", "helloasso") }}</a>
                <a href="{{ url_for('helloasso_preferences') }}?tab=status" class="item{{ tab == 'status' ? ' active' }}" data-tab="status">{{ _T("Connexion status", "helloasso") }}</a>
            </div>
            <div class="ui{{ tab == 'helloasso' ? ' active' }} tab segment" data-tab="helloasso">
                {%if login.isAdmin() %}
                    <div class="inline field">
                        <label>{{ _T("Helloasso webhook URL", "helloasso") }} :</label>
                        <code>{{ webhook_url }}</code>
                    </div>

                    {% include "components/forms/checkbox.html.twig" with {
                        id: 'helloasso_test_mode',
                        value: '1',
                        checked: helloasso.getTestMode() ? true : false,
                        label: _T("Enable test mode", "helloasso")
                    } %}

                    {% include "components/forms/text.html.twig" with {
                        id: 'helloasso_organization_slug',
                        value: helloasso.getOrganizationSlug(),
                        label: _T("Your organizationSlug", "helloasso"),
                        required: true
                    } %}

                    {% include "components/forms/text.html.twig" with {
                        id: 'helloasso_client_id',
                        value: helloasso.getClientId(),
                        label: _T("Your clientId", "helloasso"),
                        required: true
                    } %}

                    {% include "components/forms/text.html.twig" with {
                        id: 'helloasso_client_secret',
                        value: helloasso.getClientSecret(),
                        label: _T("Your clientSecret", "helloasso"),
                        required: true
                    } %}
                {% endif %}
                {% if helloasso.isLoaded() and amounts|length > 0 %}
                    <table class="listing ui celled helloassod table">
                        <thead>
                            <tr>
                                <th class="listing">{{ _T("Contribution type") }}</th>
                                <th class="listing collapsing">
                                    {{ _T("Amount") }}
                                    <i class="circular small basic question icon tooltip" aria-hidden="true" title="{{ _T("Amounts can be defined in the contributions types settings.", "helloasso") }}"></i>
                                </th>
                                <th class="listing collapsing">{{ _T("Inactive") }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for k, amount in amounts %}
                                <tr>
                                    <td>
                                        <input type="hidden" name="amount_id[]" id="amount_id_{{ k }}" value="{{ k }}"/>
                                        <label for="amount_{{ k }}">{{ amount['name'] }}</label>
                                    </td>
                                    <td class="collapsing">
                                        {{ amount['amount'] }}
                                        {% if not helloasso.isInactive(k) and amount['amount'] == 0 %}
                                             <i class="triangle exclamation orange icon tooltip" aria-hidden="true" title="{{ _T("Zero amounts, even if they are not disabled, are not proposed as a payment reason on the form. You can disable this reason, or set a positive value in the contributions types settings.", "helloasso") }}"></i>
                                        {% endif %}
                                    </td>
                                    <td class="collapsing">
                                         <div class="ui right aligned toggle checkbox">
                                            <input type="checkbox" name="inactives[]" id="inactives_{{ k }}" {% if helloasso.isInactive(k) %} checked="checked" {% endif %} value="{{ k }}"/>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endif %}
            </div>
            <div class="ui{{ tab == 'status' ? ' active' }} tab segment" data-tab="status">
                <div class="ui list">
                    <div class="item">
                        {% if helloasso.getOrganization() is not empty %}
                            <div class="ui fluid centered large green label">{{ _T("Connected to HelloAsso", "helloasso") }}</div>
                        {% else %}
                            <div class="ui fluid centered large red label">{{ _T("Not connected to HelloAsso", "helloasso") }}</div>
                        {% endif %}
                    </div>
                    {% if helloasso.getTestMode() %}
                        <div class="item">
                            <div class="ui fluid centered large orange label">{{ _T("Test mode enabled", "helloasso") }}</div>
                        </div>
                    {% endif %}
                </div>

                {% if helloasso.getOrganization() is not empty %}
                        <div class="ui relaxed divided list">
                            <div class="item">
                                <div class="content">
                                    <div class="header">{{ _T("Name", "helloasso") }}</div>
                                    <div class="description">{{ helloasso.getOrganization().name }}</div>
                                </div>
                            </div>
                        {% if helloasso.getOrganization().description is defined %}
                            <div class="item">
                                <div class="content">
                                    <div class="header">{{ _T("Description", "helloasso") }}</div>
                                    <div class="description">{{ helloasso.getOrganization().description }}</div>
                                </div>
                            </div>
                        {% endif %}
                            <div class="item">
                                <div class="content">
                                    <div class="header">{{ _T("Type", "helloasso") }}</div>
                                    <div class="description">{{ helloasso.getOrganization().type }}</div>
                                </div>
                            </div>
                            <div class="item">
                                <div class="content">
                                    <div class="header">{{ _T("Category", "helloasso") }}</div>
                                    <div class="description">{{ helloasso.getOrganization().category }}</div>
                                </div>
                            </div>
                        {% if helloasso.getOrganization().rnaNumber is defined %}
                            <div class="item">
                                <div class="content">
                                    <div class="header">{{ _T("RNA Number", "helloasso") }}</div>
                                    <div class="description">{{ helloasso.getOrganization().rnaNumber }}</div>
                                </div>
                            </div>
                        {% endif %}
                        </div>
                {% endif %}

                <div class="ui info visible center aligned message">
                    <span class="ui small text">{{ _T("HelloAsso helps organizations collect payments online and offers its services free of charge. It covers all transaction fees so you can receive all the money your audiences contribute, free of charge. The voluntary contributions they leave are their sole source of income.", "helloasso") }}</span>
                </div>
            </div>

            <div class="ui basic center aligned segment">
                <button type="submit" class="ui labeled icon primary button action">
                    <i class="save icon"></i>
                    {{ _T("Save") }}
                </button>
                <input type="hidden" name="valid" value="1"/>
                <input type="hidden" name="tab" id="tab" value="{{ tab }}"/>
                {% include "components/forms/csrf.html.twig" %}
            </div>
        {% endif %}
    </form>
{% endblock %}

{% block javascripts %}
    <script type="text/javascript">
        $(function(){
            $('.pointing.menu .item').tab({
                onVisible: function(tabPath) {
                    document.getElementById('tab').value = tabPath;
                }
            });
        });
    </script>
{% endblock %}
